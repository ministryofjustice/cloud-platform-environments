#!/bin/sh

set -o errexit
set -o pipefail

log() {
  _fg=''
  [ "${1}" = "red" ] && _fg='\033[0;31m'
  [ "${1}" = "blue" ] && _fg='\033[0;34m'
  [ "${1}" = "green" ] && _fg='\033[0;32m'
  shift
  # shellcheck disable=SC2145
  echo -e "${_fg}>>> ${@}\033[0m"
}
# changed_dirs=$(git diff HEAD^^^^^^^..HEAD --name-only --pretty=format:"" | grep 'cloud-platform-live-0.k8s.integration.dsd.io' | awk -F'/' '{print $3}' | sort | uniq)
changed_dirs=$(git diff-tree --no-commit-id --name-only -r HEAD^^^^^^..HEAD | awk 'BEGIN{FS=OFS="/"}/\/resources\//{NF-=1; print}' | sort | uniq)
echo $changed_dirs
for _c in namespaces/*; do
  cluster="$(basename ${_c})"
  log green "found cluster ${cluster}"
  ( set -x; kubectl config use-context "${cluster}" ) || { log red "no context found, skipping ${cluster}" && continue; }
  for _f in ${_c}/*; do
    if [ -d "${_f}" ]; then
      namespace="$(basename ${_f})"
      echo $namespace
      terraform_resources_path="namespaces/${cluster}/${namespace}/resources"
      if [ -d "${terraform_resources_path}" ] && echo "${changed_dirs[@]}" | grep -q "${terraform_resources_path}" ; then
      # if [ -d "${terraform_resources_path}" ] && [ "$namespace" = "$changed_dirs" ]; then
        cd "${terraform_resources_path}"
        log blue "planning terraform resources for namespace ${namespace} in ${cluster}"
        terraform init \
          -backend-config="bucket=moj-cp-k8s-investigation-environments-terraform" \
          -backend-config="key=${cluster}/${namespace}/terraform.tfstate" \
          -backend-config="region=eu-west-1"
        terraform plan \
          -var="cluster_name=${cluster%.k8s.integration.dsd.io}" \
          -var="cluster_state_bucket=moj-cp-k8s-investigation-platform-terraform"
          cd $OLDPWD
      else
        log blue "no terraform changes for namespace ${namespace} in ${cluster}"
        
      fi
    fi
  done
 done
