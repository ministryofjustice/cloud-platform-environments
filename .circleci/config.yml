version: 2

terraform: &terraform
  docker:
    - image: hashicorp/terraform:light
  working_directory: /tmp/workspace/terraform

jobs:
  validate:
    <<: *terraform
    steps:
      - checkout
      - run:
          name: Validate Terraform configurations
          command: |
            changed_resources=$(git diff --no-commit-id --name-only HEAD..master | grep /resources/ | sort | uniq)
            for _f in ${changed_resources}; do
              find ${_f} -exec dirname {} \;|sort -u | while read m; 
                do 
                  (terraform validate -check-variables=false "$m" && echo "âˆš $m") || exit 1 ;
                done 
            done 
      - run:
          name: Check if Terraform configurations are properly formatted
          command: |
            changed_resources=$(git diff --no-commit-id --name-only HEAD..master | grep /resources/ | sort | uniq)
            for _f in ${changed_resources}; do
              tf=$(terraform fmt -write=false -diff ${_f}); 
              if [[ -n "$tf" ]]; then 
                printf "$tf\n\n\nSome terraform files failed syntax validation, run 'terraform fmt' to fix\n\n"; exit 1;
              fi
            done
      - persist_to_workspace:
          root: .
          paths: 
            - .
            
workflows:
  version: 2
  build:
    jobs:
      - validate