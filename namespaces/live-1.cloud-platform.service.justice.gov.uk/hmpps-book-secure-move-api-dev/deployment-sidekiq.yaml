apiVersion: apps/v1
kind: Deployment
metadata:
  name: hmpps-book-secure-move-api-dev-sidekiq
  namespace: hmpps-book-secure-move-api-dev
  labels:
    app: hmpps-book-secure-move-api-dev-sidekiq
spec:
  replicas: 2
  revisionHistoryLimit: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: hmpps-book-secure-move-api-dev-sidekiq
  template:
    metadata:
      labels:
        app: hmpps-book-secure-move-api-dev-sidekiq
        tier: sidekiq
    spec:
      containers:
        - name: sidekiq
          image: 754256621582.dkr.ecr.eu-west-2.amazonaws.com/book-a-secure-move/hmpps-book-secure-move-api:dev.latest
          imagePullPolicy: Always
          command: ["bundle"]
          args: ["exec", "sidekiq"]

          # non-secret env vars defined in `config_map.yaml`
          envFrom:
            - configMapRef:
                name: hmpps-book-secure-move-api-configmap-dev
          env:
            - name: GOVUK_NOTIFY_ENABLED
              value: "TRUE"
            # external secrets defined in `secrets.yml`
            - name: SECRET_KEY_BASE
              valueFrom:
                secretKeyRef:
                  name: hmpps-book-secure-move-api-secrets-dev
                  key: secret_key_base_key
            - name: NOMIS_SITE
              valueFrom:
                secretKeyRef:
                  name: hmpps-book-secure-move-api-secrets-dev
                  key: nomis_site_key
            - name: NOMIS_SITE_FOR_API
              valueFrom:
                secretKeyRef:
                  name: hmpps-book-secure-move-api-secrets-dev
                  key: nomis_site_for_api_key
            - name: NOMIS_SITE_FOR_AUTH
              valueFrom:
                secretKeyRef:
                  name: hmpps-book-secure-move-api-secrets-dev
                  key: nomis_site_for_auth_key
            - name: NOMIS_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: hmpps-book-secure-move-api-secrets-dev
                  key: nomis_client_id_key
            - name: NOMIS_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: hmpps-book-secure-move-api-secrets-dev
                  key: nomis_client_secret_key
            - name: NOMIS_AUTH_SCHEME
              valueFrom:
                secretKeyRef:
                  name: hmpps-book-secure-move-api-secrets-dev
                  key: nomis_auth_scheme_key
            - name: NOMIS_API_PATH_PREFIX
              valueFrom:
                secretKeyRef:
                  name: hmpps-book-secure-move-api-secrets-dev
                  key: nomis_api_path_prefix_key
            - name: NOMIS_PRISON_API_PATH_PREFIX
              valueFrom:
                secretKeyRef:
                  name: hmpps-book-secure-move-api-secrets-dev
                  key: nomis_prison_api_path_prefix_key
            - name: NOMIS_AUTH_PATH_PREFIX
              valueFrom:
                secretKeyRef:
                  name: hmpps-book-secure-move-api-secrets-dev
                  key: nomis_auth_path_prefix_key
            - name: SENTRY_DSN
              valueFrom:
                secretKeyRef:
                  name: hmpps-book-secure-move-api-secrets-dev
                  key: sentry_dsn_key
            - name: CORS_ALLOWED_ORIGINS
              valueFrom:
                secretKeyRef:
                  name: hmpps-book-secure-move-api-secrets-dev
                  key: cors_allowed_origins_key
            - name: GOVUK_NOTIFY_API_KEY
              valueFrom:
                secretKeyRef:
                  name: hmpps-book-secure-move-api-secrets-dev
                  key: govuk_notify_api_key
            - name: GOVUK_NOTIFY_MOVE_TEMPLATE_ID
              value: "8f2e5473-15f2-4db8-a2de-153f26a0524c"
            - name: GOVUK_NOTIFY_PER_TEMPLATE_ID
              value: "e2aa6021-d0a7-475f-afce-68b49ec9c2c6"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: rds-instance-hmpps-book-secure-move-api-dev
                  key: url
            - name: AWS_DEFAULT_REGION
              value: "eu-west-2"
            - name: S3_REPORTING_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: book-a-secure-move-reporting-s3-bucket
                  key: access_key_id
            - name: S3_REPORTING_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: book-a-secure-move-reporting-s3-bucket
                  key: secret_access_key
            - name: S3_REPORTING_BUCKET_NAME
              valueFrom:
                secretKeyRef:
                  name: book-a-secure-move-reporting-s3-bucket
                  key: bucket_name
            - name: S3_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: book-a-secure-move-documents-s3-bucket
                  key: access_key_id
            - name: S3_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: book-a-secure-move-documents-s3-bucket
                  key: secret_access_key
            - name: S3_BUCKET_ARN
              valueFrom:
                secretKeyRef:
                  name: book-a-secure-move-documents-s3-bucket
                  key: bucket_arn
            - name: S3_BUCKET_NAME
              valueFrom:
                secretKeyRef:
                  name: book-a-secure-move-documents-s3-bucket
                  key: bucket_name
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: elasticache-hmpps-book-secure-move-api-dev
                  key: url
