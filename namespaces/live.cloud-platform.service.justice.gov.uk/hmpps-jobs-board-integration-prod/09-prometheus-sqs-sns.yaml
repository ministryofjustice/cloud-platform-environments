apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    app: hmpps-jobs-board-integration-api
    prometheus: cloud-platform
  name: jb-intg-prometheus-rules-sqs
  namespace: hmpps-jobs-board-integration-prod
spec:
  groups:
  - name: JB-INTG-SQS
    rules:
    - alert: SQS-events-dlq-not-empty
      annotations:
        message: SQS Deadletter queue - {{ $labels.queue_name }} has {{ $value }} messages
        runbook_url: https://dsdmoj.atlassian.net/wiki/x/04CSTAE
        dashboard_url: https://grafana.live.cloud-platform.service.justice.gov.uk/d/AWSSQS000/aws-sqs?orgId=1&var-datasource=Cloudwatch&var-region=default&var-queue={{ $labels.queue_name }}&from=now-6h&to=now
      expr: |-
        sum(aws_sqs_approximate_number_of_messages_visible_maximum{
          queue_name="education-skills-work-employment-prod-hmpps_jobs_board_integration_dlq"
        } offset 5m) by (queue_name) > 0
      for: 10m
      labels:
        severity: education-alerts
