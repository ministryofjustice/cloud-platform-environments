apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  namespace: justice-gov-uk-dev
  labels:
    prometheus: prometheus-operator
    role: alert-rules
    release: prometheus-operator
  name: monitoring-rules-justice-gov-uk
spec:
  groups:
  - name: kubernetes-apps
    rules:
    - alert: KubeQuotaAlmostFull
      annotations:
        description: Namespace {{ $labels.namespace }} is using {{ $value | humanizePercentage }} of its {{ $labels.resource }} quota.
        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/kubernetes/kubequotaalmostfull
        summary: Namespace quota is going to be full.
      expr: |
        kube_resourcequota{job="kube-state-metrics", type="used", namespace="justice-gov-uk-dev"}
          / ignoring(instance, job, type)
        (kube_resourcequota{job="kube-state-metrics", type="hard", namespace="justice-gov-uk-dev"} > 0)
          > 0.9 < 1
      for: 15m
      labels:
        severity: justice-gov-uk-alerts
    - alert: KubeQuota-Exceeded
      annotations:
        message: Namespace {{ $labels.namespace }} is using {{ printf "%0.0f" $value
          }}% of its {{ $labels.resource }} quota.
        runbook_url: https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubequotaexceeded
      expr: |-
        100 * kube_resourcequota{job="kube-state-metrics", type="used", namespace="justice-gov-uk-dev"} 
        / ignoring(instance, job, type)
        (kube_resourcequota{job="kube-state-metrics", type="hard", namespace="justice-gov-uk-dev"} > 0)
        > 90
      for: 15m
      labels:
        severity: justice-gov-uk-alerts
    - alert: KubePodCrashLooping
      # pint file/disable alerts/template
      annotations:
        message: Pod {{ $labels.namespace }}/{{ $labels.pod }} ({{ $labels.container
          }}) is restarting {{ printf "%.2f" $value }} times / 5 minutes.
        runbook_url: https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubepodcrashlooping
      expr: |-
        rate(kube_pod_container_status_restarts_total{job="kube-state-metrics", namespace="justice-gov-uk-dev"}[15m]) * 60 * 5 > 0
      for: 1h
      labels:
        severity: justice-gov-uk-alerts
    - alert: KubePodNotReady
      annotations:
        message: Pod {{ $labels.namespace }}/{{ $labels.pod }} has been in a non-ready
          state for longer than an hour.
        runbook_url: https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubepodnotready
      expr: |-
        sum by (namespace, pod) (kube_pod_status_phase{job="kube-state-metrics", phase=~"Pending|Unknown", namespace="justice-gov-uk-dev"}) 
        > 0
      for: 1h
      labels:
        severity: justice-gov-uk-alerts
    - alert: KubeDeploymentGenerationMismatch
      annotations:
        message: Deployment generation for {{ $labels.namespace }}/{{ $labels.deployment
          }} does not match, this indicates that the Deployment has failed but has
          not been rolled back.
        runbook_url: https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubedeploymentgenerationmismatch
      expr: |-
        kube_deployment_status_observed_generation{job="kube-state-metrics", namespace="justice-gov-uk-dev"}
        !=
        kube_deployment_metadata_generation{job="kube-state-metrics", namespace="justice-gov-uk-dev"}
      for: 15m
      labels:
        severity: justice-gov-uk-alerts

  - name: s3-antivirus-scan
    rules:
    - alert: S3AntiVirusJobFailed
      annotations:
        message: |-
          An antivirus job in namespace {{ $labels.namespace }} has failed. Click the Dashboard link to view logs in Kibana.
          To clear this alert, delete the failed job with: kubectl delete job s3-antivirus-scan-job -n {{ $labels.namespace }}
        runbook_url: https://dsdmoj.atlassian.net/wiki/spaces/CDPT/pages/5124292758/Alerts+PHP+NodeJS+runbooks#S3AntiVirusJobFailed
        summary: S3 Antivirus Scan Job has failed.
        dashboard_url: https://app-logs.cloud-platform.service.justice.gov.uk/_dashboards/app/data-explorer/discover#?_a=(discover:(columns:!(kubernetes.container_name,log),isDirty:!f,sort:!()),metadata:(indexPattern:bb90f230-0d2e-11ef-bf63-53113938c53a,view:discover))&_g=(time:(from:now-7d,to:now))&_q=(filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:bb90f230-0d2e-11ef-bf63-53113938c53a,key:kubernetes.namespace_name,negate:!f,params:(query:justice-gov-uk-dev),type:phrase),query:(match_phrase:(kubernetes.namespace_name:justice-gov-uk-dev))),('$state':(store:appState),meta:(alias:!n,disabled:!f,index:bb90f230-0d2e-11ef-bf63-53113938c53a,key:kubernetes.container_name,negate:!f,params:(query:s3-antivirus-scan),type:phrase),query:(match_phrase:(kubernetes.container_name:s3-antivirus-scan)))))
      expr: |
        kube_job_failed{namespace="justice-gov-uk-dev",job_name="s3-antivirus-scan-job"} > 0
      for: 0m
      labels:
        severity: justice-gov-uk-dev-alerts
    - alert: S3AntiVirusCronJobFailed
      annotations:
        message: An scheduled antivirus job in namespace {{ $labels.namespace }} has failed. Click the Dashboard link for to view the logs.
        runbook_url: https://dsdmoj.atlassian.net/wiki/spaces/CDPT/pages/5124292758/Alerts+PHP+NodeJS+runbooks#S3AntiVirusJobFailed
        summary: S3 Antivirus Scan CronJob has failed.
        dashboard_url: https://app-logs.cloud-platform.service.justice.gov.uk/_dashboards/app/data-explorer/discover#?_a=(discover:(columns:!(kubernetes.container_name,log),isDirty:!f,sort:!()),metadata:(indexPattern:bb90f230-0d2e-11ef-bf63-53113938c53a,view:discover))&_g=(time:(from:now-7d,to:now))&_q=(filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:bb90f230-0d2e-11ef-bf63-53113938c53a,key:kubernetes.namespace_name,negate:!f,params:(query:justice-gov-uk-dev),type:phrase),query:(match_phrase:(kubernetes.namespace_name:justice-gov-uk-dev))),('$state':(store:appState),meta:(alias:!n,disabled:!f,index:bb90f230-0d2e-11ef-bf63-53113938c53a,key:kubernetes.container_name,negate:!f,params:(query:s3-antivirus-scan),type:phrase),query:(match_phrase:(kubernetes.container_name:s3-antivirus-scan)))))
      expr: |
        kube_job_failed{namespace="justice-gov-uk-dev",job_name=~"s3-antivirus-scan-weekly.*"} > 0
      for: 0m
      labels:
        severity: justice-gov-uk-dev-alerts
