apiVersion: batch/v1
kind: CronJob
metadata:
  name: hmpps-manage-and-deliver-ap-s3-file-transfer
  namespace: hmpps-manage-and-deliver-accredited-programmes-dev
spec:
  schedule: "0 0 31 2 *" # Disabled schedule (Feb 31 â€” never runs automatically)
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 5
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        spec:
          serviceAccountName: irsa-cronjob
          restartPolicy: OnFailure
          containers:
            - name: s3-transfer
              image: amazon/aws-cli:2.15.15
              imagePullPolicy: IfNotPresent
              env:
                - name: upload_s3_bucket_name
                  valueFrom:
                    secretKeyRef:
                      name: upload-s3-bucket-output
                      key: bucket_name
                - name: sqlserver_backup_s3_bucket_name
                  valueFrom:
                    secretKeyRef:
                      name: sqlserver-backup-s3-bucket-output
                      key: bucket_name
              command:
                - /bin/sh
                - -c
              args:
                - |
                  set -euo pipefail

                  echo "Starting S3 transfer at $(date)"

                  aws s3 sync \
                    s3://$upload_s3_bucket_name \
                    s3://$sqlserver_backup_s3_bucket_name \
                    --only-show-errors

                  echo "Sync complete. Deleting source objects..."

                  aws s3 rm \
                    s3://$upload_s3_bucket_name \
                    --recursive \
                    --only-show-errors

                  echo "Transfer completed successfully at $(date)"
