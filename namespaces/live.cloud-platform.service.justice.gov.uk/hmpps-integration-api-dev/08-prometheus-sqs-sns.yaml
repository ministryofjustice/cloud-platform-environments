apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    app: hmpps-integration-api-dev
    prometheus: cloud-platform
  name: integration-api-prometheus-rules-sqs
  namespace: hmpps-integration-api-dev
spec:
  groups:
    - name: INTEGRATION-API-SQS-SNS-dev
      rules:
        - alert: INTEGRATION-API-SQS-events-dlq-not-empty
          annotations:
            message: DEV SQS Deadletter queue - {{ $labels.queue_name }} has {{ $value }} messages
            runbook_url: https://dsdmoj.atlassian.net/wiki/spaces/NOM/pages/1739325587/DPS+Runbook
            dashboard_url: https://grafana.live.cloud-platform.service.justice.gov.uk/d/AWSSQS000/aws-sqs?orgId=1&var-datasource=Cloudwatch&var-region=default&var-queue={{ $labels.queue_name }}&from=now-6h&to=now
          expr: |-
            sum(aws_sqs_approximate_number_of_messages_visible_maximum{
              queue_name=~"hmpps-integration-api-dev-(integration_api_domain_events_queue_|event_mapps_queue|event_test_client_queue|event_pnd_queue|event_plp_queue).*_dl.*"
            } offset 5m) by (queue_name) > 0
          for: 10m
          labels:
            severity: hmpps-integration-api-alerts
