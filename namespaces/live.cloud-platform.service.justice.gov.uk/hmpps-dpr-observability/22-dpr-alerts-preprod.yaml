---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: dpr-alerts-preprod
  namespace: hmpps-dpr-observability
  labels:
    role: alert-rules
spec:
  groups:
  - name: dpr-golden-signals-preprod
    rules:
    # ============================================
    # LATENCY ALERTS
    # ============================================
    - alert: DPR-Preprod-HighLatencyP95
      expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{namespace=~"hmpps-dpr-.*-preprod|hmpps-digital-prison-reporting-.*-preprod"}[5m])) by (namespace, le)) > 2
      for: 5m
      labels:
        severity: dpr-preprod
      annotations:
        message: "[PREPROD] High p95 latency ({{ $value | printf \"%.2f\" }}s) in namespace {{ $labels.namespace }}"
        runbook_url: "https://github.com/ministryofjustice/hmpps-digital-prison-reporting-poc/blob/main/docs/runbooks/latency.md"
        dashboard_url: "https://grafana.live.cloud-platform.service.justice.gov.uk/d/dpr-golden-signals-java"

    - alert: DPR-Preprod-CriticalLatencyP95
      expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{namespace=~"hmpps-dpr-.*-preprod|hmpps-digital-prison-reporting-.*-preprod"}[5m])) by (namespace, le)) > 5
      for: 2m
      labels:
        severity: dpr-preprod
      annotations:
        message: "[PREPROD] CRITICAL p95 latency ({{ $value | printf \"%.2f\" }}s) in namespace {{ $labels.namespace }}"
        runbook_url: "https://github.com/ministryofjustice/hmpps-digital-prison-reporting-poc/blob/main/docs/runbooks/latency.md"
        dashboard_url: "https://grafana.live.cloud-platform.service.justice.gov.uk/d/dpr-golden-signals-java"

    # ============================================
    # ERROR RATE ALERTS
    # ============================================
    - alert: DPR-Preprod-HighErrorRate
      expr: |
        (
          sum(rate(http_server_requests_seconds_count{namespace=~"hmpps-dpr-.*-preprod|hmpps-digital-prison-reporting-.*-preprod", status=~"5.."}[5m])) by (namespace)
          /
          sum(rate(http_server_requests_seconds_count{namespace=~"hmpps-dpr-.*-preprod|hmpps-digital-prison-reporting-.*-preprod"}[5m])) by (namespace)
        ) * 100 > 3
      for: 5m
      labels:
        severity: dpr-preprod
      annotations:
        message: "[PREPROD] High error rate ({{ $value | printf \"%.1f\" }}%) in namespace {{ $labels.namespace }}"
        runbook_url: "https://github.com/ministryofjustice/hmpps-digital-prison-reporting-poc/blob/main/docs/runbooks/errors.md"
        dashboard_url: "https://grafana.live.cloud-platform.service.justice.gov.uk/d/dpr-golden-signals-java"

    - alert: DPR-Preprod-CriticalErrorRate
      expr: |
        (
          sum(rate(http_server_requests_seconds_count{namespace=~"hmpps-dpr-.*-preprod|hmpps-digital-prison-reporting-.*-preprod", status=~"5.."}[5m])) by (namespace)
          /
          sum(rate(http_server_requests_seconds_count{namespace=~"hmpps-dpr-.*-preprod|hmpps-digital-prison-reporting-.*-preprod"}[5m])) by (namespace)
        ) * 100 > 10
      for: 2m
      labels:
        severity: dpr-preprod
      annotations:
        message: "[PREPROD] CRITICAL error rate ({{ $value | printf \"%.1f\" }}%) in namespace {{ $labels.namespace }}"
        runbook_url: "https://github.com/ministryofjustice/hmpps-digital-prison-reporting-poc/blob/main/docs/runbooks/errors.md"
        dashboard_url: "https://grafana.live.cloud-platform.service.justice.gov.uk/d/dpr-golden-signals-java"

    # ============================================
    # SATURATION ALERTS (CPU)
    # ============================================
    - alert: DPR-Preprod-HighCPUSaturation
      expr: |
        (
          sum(rate(container_cpu_usage_seconds_total{namespace=~"hmpps-dpr-.*-preprod|hmpps-digital-prison-reporting-.*-preprod", container!="POD", container=~".+"}[5m])) by (namespace)
          /
          sum(kube_pod_container_resource_requests{namespace=~"hmpps-dpr-.*-preprod|hmpps-digital-prison-reporting-.*-preprod", resource="cpu"}) by (namespace)
        ) * 100 > 80
      for: 10m
      labels:
        severity: dpr-preprod
      annotations:
        message: "[PREPROD] High CPU saturation ({{ $value | printf \"%.1f\" }}%) in namespace {{ $labels.namespace }}"
        runbook_url: "https://github.com/ministryofjustice/hmpps-digital-prison-reporting-poc/blob/main/docs/runbooks/saturation.md"
        dashboard_url: "https://grafana.live.cloud-platform.service.justice.gov.uk/d/dpr-golden-signals-java"

    # ============================================
    # SATURATION ALERTS (MEMORY)
    # ============================================
    - alert: DPR-Preprod-HighMemorySaturation
      expr: |
        (
          sum(container_memory_usage_bytes{namespace=~"hmpps-dpr-.*-preprod|hmpps-digital-prison-reporting-.*-preprod", container!="POD", container=~".+"}) by (namespace)
          /
          sum(kube_pod_container_resource_requests{namespace=~"hmpps-dpr-.*-preprod|hmpps-digital-prison-reporting-.*-preprod", resource="memory"}) by (namespace)
        ) * 100 > 80
      for: 10m
      labels:
        severity: dpr-preprod
      annotations:
        message: "[PREPROD] High memory saturation ({{ $value | printf \"%.1f\" }}%) in namespace {{ $labels.namespace }}"
        runbook_url: "https://github.com/ministryofjustice/hmpps-digital-prison-reporting-poc/blob/main/docs/runbooks/saturation.md"
        dashboard_url: "https://grafana.live.cloud-platform.service.justice.gov.uk/d/dpr-golden-signals-java"

    # ============================================
    # POD HEALTH ALERTS
    # ============================================
    - alert: DPR-Preprod-PodNotReady
      expr: |
        kube_pod_status_ready{namespace=~"hmpps-dpr-.*-preprod|hmpps-digital-prison-reporting-.*-preprod", condition="true"} == 0
      for: 5m
      labels:
        severity: dpr-preprod
      annotations:
        message: "[PREPROD] Pod {{ $labels.pod }} in {{ $labels.namespace }} is not ready"
        runbook_url: "https://github.com/ministryofjustice/hmpps-digital-prison-reporting-poc/blob/main/docs/runbooks/pod-issues.md"
        dashboard_url: "https://grafana.live.cloud-platform.service.justice.gov.uk/d/dpr-golden-signals-java"

    - alert: DPR-Preprod-PodRestarting
      expr: |
        increase(kube_pod_container_status_restarts_total{namespace=~"hmpps-dpr-.*-preprod|hmpps-digital-prison-reporting-.*-preprod"}[1h]) > 3
      for: 5m
      labels:
        severity: dpr-preprod
      annotations:
        message: "[PREPROD] Pod {{ $labels.pod }} in {{ $labels.namespace }} has restarted {{ $value | printf \"%.0f\" }} times in the last hour"
        runbook_url: "https://github.com/ministryofjustice/hmpps-digital-prison-reporting-poc/blob/main/docs/runbooks/pod-issues.md"
        dashboard_url: "https://grafana.live.cloud-platform.service.justice.gov.uk/d/dpr-golden-signals-java"
