on:
  pull_request:
    paths:
      - 'namespaces/live.cloud-platform.service.justice.gov.uk/aaf-dev/**'
  workflow_dispatch:
    
jobs:
  ecr-deletion-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          write_output_files: true
      
      - uses: actions/checkout@v4
        with:
          ref: temp-main-ecr
            
      - name: Get deletion protection
        id: deletion-protection
        env:
          DELETED_FILES : ${{ steps.changed-files.outputs.deleted_files }}
          MODIFIED_FILES: ${{ steps.changed-files.outputs.modified_files }}
        run: |
          for file in $DELETED_FILES $MODIFIED_FILES; do
            if [[ "$file" =~ ^.*/resources/ecr.*\.tf$ ]]; then
              sed '/^[[:space:]]*#/d' $file > $file.tmp
              if grep -q "deletion_protection" $file.tmp; then
                DELETION_PROTECTION=$(sed -n 's/^[[:space:]]*deletion_protection[[:space:]]*=[[:space:]]*\(true\|false\).*$/\1/p' $file.tmp)
              else
                DELETION_PROTECTION=true
              fi
              echo "deletionProtection=$DELETION_PROTECTION" >> $GITHUB_OUTPUT
              echo $DELETION_PROTECTION
              break
            fi
          done

      # - name: Get all deleted files
      #   id: deleted-files
      #   if: steps.changed-files.outputs.deleted_files_count > 0
      #   env:
      #     DELETED_FILES : ${{ steps.changed-files.outputs.deleted_files }}
      #     MODIFIED_FILES: ${{ steps.changed-files.outputs.modified_files }}
      #   run: |
      #     for file in ${DELETED_FILES}; do
      #       if [[ "$file" =~ ^.*/resources/ecr.*\.tf$ ]]; then
      #         echo "ecrDeleted=true" >> $GITHUB_OUTPUT
      #         break
      #       else
      #         echo "ecrDeleted=false" >> $GITHUB_OUTPUT
      #       fi
      #     done
          
      # - name: Comment on PR
      #   env:
      #     GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}" 
      #   if: steps.deleted-files.outputs.ecrDeleted == 'true'
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       github.rest.issues.createComment({
      #         issue_number: context.issue.number,
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: 'You are deleting an existing ecr resource from your terraform configuration. \
      #         Make sure you have deletion_protection disabled for your ecr and applied this terraform change'
      #       });
        
      # Check the PR diff using the current branch and the base branch of the PR
      - uses: actions/checkout@v4

      - name: Get diff
        uses: GrantBirki/git-diff-action@v2.7.0
        id: git-diff-action
        with:
          json_diff_file_output: diff.json
          raw_diff_file_output: diff.txt
          file_output_only: "true"
          git_options: "--word-diff=plain --unified=0"

      # Print the diff in raw git format
      - name: print raw diff
        env:
          DIFF: ${{ steps.git-diff-action.outputs.raw-diff-path }}
        run: cat $DIFF
          # grep 'deletion_protection' $DIFF