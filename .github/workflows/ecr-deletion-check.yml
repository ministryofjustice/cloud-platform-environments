on:
  pull_request:
    paths:
      - 'namespaces/live.cloud-platform.service.justice.gov.uk/aaf-dev/**'
  workflow_dispatch:
    
jobs:
  ecr-deletion-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        # with:
        #  fetch-depth: 0 

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          write_output_files: true
            
      # # Check the PR diff using the current branch and the base branch of the PR
      # - name: Get diff
      #   uses: GrantBirki/git-diff-action@v2.7.0
      #   id: git-diff-action
      #   with:
      #     json_diff_file_output: diff.json
      #     raw_diff_file_output: diff.txt
      #     file_output_only: "true"
      #     git_options: "--word-diff=plain --unified=0"

      # # Print the diff in raw git format
      # - name: print raw diff
      #   env:
      #     DIFF: ${{ steps.git-diff-action.outputs.raw-diff-path }}
      #   run: cat $DIFF
      
      - uses: actions/checkout@v4
        with:
          ref: temp-main-ecr
      
      - name: Get deletion protection
        id: deletion-protection
        env:
          DELETED_FILES : ${{ steps.changed-files.outputs.deleted_files }}
          MODIFIED_FILES: ${{ steps.changed-files.outputs.modified_files }}
        run: |
          DELETION_PROTECTION=
          for file in $DELETED_FILES $MODIFIED_FILES; do
            if [[ "$file" =~ ^.*/resources/ecr.*\.tf$ ]]; then
              sed '/^[[:space:]]*#/d' $file > $file.tmp
              if grep -q "deletion_protection" $file.tmp; then
                DELETION_PROTECTION=$(sed -n 's/^[[:space:]]*deletion_protection[[:space:]]*=[[:space:]]*\(true\|false\).*$/\1/p' $file.tmp)
              else
                DELETION_PROTECTION=true
              fi
              echo "deletionProtection=$DELETION_PROTECTION" >> $GITHUB_OUTPUT
              echo $DELETION_PROTECTION
              break
            fi
          done
          echo "deletionProtection=$DELETION_PROTECTION" >> $GITHUB_OUTPUT

      - name: Create comment in the PR
        uses: peter-evans/create-or-update-comment@v4

        if: steps.deletion-protection.outputs.deletionProtection == 'true'
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            You are deleting an existing ecr resource from your terraform configuration. \
            Make sure you have deletion_protection disabled for your ecr and applied this terraform change'

      - name: Fail action when ecr is deleted without deletion_protection disabled
        if: steps.deletion-protection.outputs.deletionProtection == 'true'
        run: exit 1

