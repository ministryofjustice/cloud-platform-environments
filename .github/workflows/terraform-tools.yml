name: static-anlysis

on:
  push:
    branches: [ tf-static-analysis ]
  pull_request:
  workflow_dispatch:

jobs:
  static-analysis:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: rm -r namespace-resources-cli-template # remove the template from being linted
      - run: rm -r cmd/ # remove the templates in the cmd directory from being linted
      - name: Run Analysis
        uses: ministryofjustice/github-actions/terraform-static-analysis@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          scan_type: changed
          tfsec_exclude: AWS095
          tflint_config: $(realpath .tflint.hcl)
          tfsec_output_file: tfsec.sarif
          tfsec_output_format: sarif
          checkov_external_modules: true
          checkov_exclude: CKV_TF_1,CKV_AWS_136,CKV_AWS_51,CKV_GIT_4
          tflint_exclude: terraform_standard_module_structure

      # - uses: aquasecurity/tfsec-sarif-action@v0.1.4
      #   with:
      #     tfsec_args: --force-all-dirs --soft-fail -m=HIGH -e=github-repositories-private,github-branch_protections-require_signed_commits,github-actions-no-plain-text-action-secrets,aws-iam-no-policy-wildcards,aws-ecr-enforce-immutable-repository,aws-rds-enable-performance-insights-encryption,aws-s3-encryption-customer-key,aws-sqs-enable-queue-encryption
      #     sarif_file: tfsec.sarif
      # - uses: github/codeql-action/upload-sarif@v2
      #   with:
      #     sarif_file: tfsec.sarif
      # - run: tflint -c $(realpath .tflint.hcl) -f compact --recursive --only=terraform_comment_syntax --only=terraform_deprecated_index --only=terraform_deprecated_interpolation --only=terraform_documented_outputs --only=terraform_empty_list_equality --only=terraform_module_pinned_source --only=terraform_module_version --only=terraform_required_providers --only=terraform_required_version --only=terraform_unused_required_providers --only=terraform_workspace_remote # enable rules that pass at the current time only, whilst the others are rectified on multiple namespaces (see: https://github.com/terraform-linters/tflint-ruleset-terraform/tree/main/docs/rules)
