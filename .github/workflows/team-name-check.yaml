name: team-name-check

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'namespaces/**/00-namespace.yaml'
      - '**/*.tf'

jobs:
  team-name-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4

      - name: Get changed files
        id: files
        uses: tj-actions/changed-files@v46
        with:
          files_ignore: '.github/**'

      - name: Check for team_name changes and resources
        id: check_team_name
        run: |
          TEAM_NAME_CHANGED=false
          MODULES_FOUND=()
          
          echo "Changed files: ${{ steps.files.outputs.all_changed_files }}"
          
          for file in ${{ steps.files.outputs.all_changed_files }}; do
            echo "Processing file: $file"
            
            # Check for changes in 00-namespace.yaml
            if [[ $file == *00-namespace.yaml ]]; then
              echo "Checking team_name in $file"
              
              # Extract team_name from the base branch
              BASE_TEAM_NAME=$(git show origin/${{ github.base_ref }}:$file | grep -oP 'cloud-platform.justice.gov.uk/team-name: "\K[^"]+' || echo "NOT_FOUND")
              # Extract team_name from the PR branch
              PR_TEAM_NAME=$(grep -oP 'cloud-platform.justice.gov.uk/team-name: "\K[^"]+' "$file" || echo "NOT_FOUND")

              echo "Base team_name: $BASE_TEAM_NAME"
              echo "PR team_name: $PR_TEAM_NAME"

              if [[ "$BASE_TEAM_NAME" != "$PR_TEAM_NAME" ]]; then
                TEAM_NAME_CHANGED=true
              fi
            fi

            # Check for ecr, sns, or sqs resources in Terraform files
            if [[ $file == *.tf ]]; then
              echo "Checking for ecr, sns, or sqs modules in $file"
              if grep -q -E '(module.*sqs|module.*sns|module.*ecr)' "$file"; then
                MODULES_FOUND+=("$file")
              fi
            fi
          done

          # Ensure MODULES_FOUND is a space-separated string
          MODULES_FOUND_STRING=$(IFS=" "; echo "${MODULES_FOUND[*]}")

          echo "Final team_name_changed: $TEAM_NAME_CHANGED"
          echo "Modules found: $MODULES_FOUND_STRING"
          echo "::set-output name=team_name_changed::$TEAM_NAME_CHANGED"
          echo "::set-output name=modules_found::$MODULES_FOUND_STRING"

      - name: Post PR comment
        if: ${{ steps.check_team_name.outputs.team_name_changed == 'true' || steps.check_team_name.outputs.modules_found != '' }}
        uses: actions/github-script@v6
        with:
            script: |
              const modules = `${{ steps.check_team_name.outputs.modules_found }}`.split(' ').filter(Boolean);
              const moduleList = modules.length > 0 ? modules.map(module => `- ${module}`).join('\n') : 'none';
              const comment = `
              We've noticed you're updating your \`team_name\`. Please note that you have the following resources that cannot be renamed:

              ${moduleList}

              See [documentation](https://github.com/ministryofjustice/cloud-platform-terraform-ecr-credentials?tab=readme-ov-file#team-name-caveat) for more details.
              `;
              github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });